<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial data and the tidyverse: pitfalls to avoid • geocompkg | metapackage for the book Gecomputation with R</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spatial data and the tidyverse: pitfalls to avoid">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geocompkg | metapackage for the book Gecomputation with R</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.75</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="https://geocompr.github.io/">Home</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/geocompr/geocompkg">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Spatial data and the tidyverse: pitfalls to avoid</h1>
                        <h4 class="author">Robin Lovelace, Jakub Nowosad, Jannes Muenchow</h4>
            
            <h4 class="date">2019-03-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/geocompr/geocompkg/blob/master/vignettes/tidyverse-pitfalls.Rmd"><code>vignettes/tidyverse-pitfalls.Rmd</code></a></small>
      <div class="hidden name"><code>tidyverse-pitfalls.Rmd</code></div>

    </div>

    
    
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>This article is about working with spatial data ‘in the tidyverse’. By this we mean handling spatial datasets using functions (such as <code>%&gt;%</code> and <code><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter()</a></code>) and concepts (such as type stability) from R packages that are part of the metapackage <strong>tidyverse</strong>. You should already have an R installation set-up for spatial data analysis <a href="https://geocompr.robinlovelace.net/spatial-class.html">having read Chapter 2</a> of <a href="https://geocompr.github.io/">the Geocomputation with R book</a>.</p>
<p>If not take a read there now. In any case the <strong>tidyverse</strong> can be installed from CRAN with the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"tidyverse"</span>)</a></code></pre></div>
<p>The <strong>tidyverse</strong> works with spatial data thanks to <strong>sf</strong> which is quite a recent package (first release in 2016). If you have not already got it, get <strong>sf</strong> with:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"sf"</span>)</a></code></pre></div>
<p>The we will also uses a dataset from the <strong>spData</strong> package, which can be installed with:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"spData"</span>)</a></code></pre></div>
</div>
<div id="context" class="section level2">
<h2 class="hasAnchor">
<a href="#context" class="anchor"></a>Context</h2>
<p>Software for ‘data science’ is evolving. As we saw in <a href="https://geocompr.robinlovelace.net/intro.html">Chapter 1</a>, R packages <strong>ggplot2</strong> and <strong>dplyr</strong> have become immensely popular. Now they are a part of the <strong>tidyverse</strong>.</p>
<p>These packages use the ‘tidy data’ principles for consistency and speed of processing. According to the <code>vignette("tidy-data")</code>, in tidy datasets:</p>
<ul>
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observational unit forms a table</li>
</ul>
<p>Historically spatial R packages have not been compatible with the <strong>tidyverse</strong>. But this has changed with the release of <strong>sf</strong> and hard work by Edzer Pebesma and Hadley Wickham to make them work together. As described in <a href="https://geocompr.robinlovelace.net/spatial-class.html">Chapter 2</a>, <strong>sf</strong> combines the functionality of three previous packages: <strong>sp</strong>, <strong>rgeos</strong> and <strong>rgdal</strong>. It has many other advantages, including:</p>
<ul>
<li>Consistent function names (<code>st_*</code>)</li>
<li>More geometry types supported</li>
<li>Pulls in functionality from <strong>lwgeom</strong>
</li>
<li>Compatibility with the <strong>tidyverse</strong>
</li>
</ul>
<p>The final advantage comes with a warning: watch out for pitfalls! That’s topic of this vignette, as illustrated by the following GIF: it’s easy to imagine spatial data analyses but, as Homer Simson discovered with his BBQ project, doing something complicated is easier said than done, especially when combining packages that have only recently started working together:</p>
<p><img src="https://media.giphy.com/media/OMeGDxdAsMPzW/giphy.gif"></p>
</div>
<div id="loading-spatial-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-spatial-packages" class="anchor"></a>Loading spatial packages</h2>
<p>Now you know the context and have your R setup sorted, it’s time to begin the practical. Execute the following 2 commands to attach spatial data libraries:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(sf)</a></code></pre></div>
<pre><code>## Linking to GEOS 3.7.0, GDAL 2.3.2, PROJ 5.2.0</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(raster)</a></code></pre></div>
<pre><code>## Loading required package: sp</code></pre>
<p>Notice the messages: <strong>sf</strong> uses some C libraries behind the scenes. <strong>raster</strong> depends on the older <strong>sp</strong> package which <strong>sf</strong> replaces (confusing I know!).</p>
<p>The next step is to attach the tidyverse, which brings us onto the first pitfall.</p>
</div>
<div id="pitfall-name-clashes" class="section level2">
<h2 class="hasAnchor">
<a href="#pitfall-name-clashes" class="anchor"></a>Pitfall: name clashes</h2>
<p>Just loading the tidyverse reveals a pitfall of using spatial data with the tidyverse that affects the <strong>raster</strong> package in particular:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a></code></pre></div>
<pre><code>## ── Attaching packages ──────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.1.0       ✔ purrr   0.3.1  
## ✔ tibble  2.0.1       ✔ dplyr   0.8.0.1
## ✔ tidyr   0.8.3       ✔ stringr 1.4.0  
## ✔ readr   1.3.1       ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ─────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ tidyr::extract() masks raster::extract()
## ✖ dplyr::filter()  masks stats::filter()
## ✖ dplyr::lag()     masks stats::lag()
## ✖ dplyr::select()  masks raster::select()</code></pre>
<p>The first chunk of output shows that the tidyverse is attaching its packages. ✔ yes we want <strong>ggplot2</strong>, ✔ we want <strong>dplyr</strong> etc. But we also get less positive messages. ✖ Doh! there are many conflicts.</p>
<p>In the context of spatial data this may only be a problem if you use the <strong>raster</strong> package. The final ✖ shows that <strong>dplyr</strong>’s <code><a href="https://www.rdocumentation.org/packages/raster/topics/select">select()</a></code> function has boshed (technically speaking, masked) <strong>raster</strong>’s select function. This can cause issues. To avoid this pitfall we suggest using <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code> and <code><a href="https://www.rdocumentation.org/packages/raster/topics/select">raster::select()</a></code> rather than just <code><a href="https://www.rdocumentation.org/packages/raster/topics/select">select()</a></code> when using this conflicted function name if you use <strong>raster</strong> and the <strong>tidyverse</strong>.</p>
</div>
<div id="pitfall-tidyverse-and-sp-dont-play" class="section level2">
<h2 class="hasAnchor">
<a href="#pitfall-tidyverse-and-sp-dont-play" class="anchor"></a>Pitfall: tidyverse and sp don’t play</h2>
<ul>
<li>
<strong>sp</strong> precedes <strong>sf</strong><br>
</li>
<li>Together with the <strong>rgdal</strong> and <strong>rgeos</strong> package, it creates a powerful tool to works with spatial data</li>
<li>Many spatial R packages still depend on the <strong>sp</strong> package, therefore it is important to know how to convert <strong>sp</strong> to and from <strong>sf</strong> objects</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(spData)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">world_sp =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/coerce-methods">as</a></span>(world, <span class="st">"Spatial"</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">world_sf =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/st_as_sf">st_as_sf</a></span>(world_sp)</a></code></pre></div>
<ul>
<li>The structures in the <strong>sp</strong> packages are more complicated - <code><a href="https://www.rdocumentation.org/packages/utils/topics/str">str(world_sf)</a></code> vs <code><a href="https://www.rdocumentation.org/packages/utils/topics/str">str(world_sp)</a></code>
</li>
<li>
<strong>sp</strong> doesn’t play well with the <strong>tidyverse</strong>:</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">world_sp <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(name_long <span class="op">==</span><span class="st"> "England"</span>)</a></code></pre></div>
<p><code>Error in UseMethod("filter_") :    no applicable method for 'filter_' applied to an object of class "c('SpatialPolygonsDataFrame', 'SpatialPolygons', 'Spatial')"</code></p>
</div>
<div id="pitfall-multipolygon-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#pitfall-multipolygon-objects" class="anchor"></a>Pitfall: multipolygon objects</h2>
<p>This pitfall is not specific to the tidyverse but is worth being aware of. Let’s create a buffer around London of 500 km:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">lnd_buff =<span class="st"> </span>lnd[<span class="dv">1</span>, ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/st_transform">st_transform</a></span>(<span class="dt">crs =</span> <span class="dv">27700</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># uk CRS</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/geos_unary">st_buffer</a></span>(<span class="dv">500000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/st_transform">st_transform</a></span>(<span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">near_lnd =<span class="st"> </span>world[lnd_buff, ]</a></code></pre></div>
<pre><code>## although coordinates are longitude/latitude, st_intersects assumes that they are planar</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(near_lnd<span class="op">$</span>geom)</a></code></pre></div>
<p><img src="tidyverse-pitfalls_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>What is going with the country miles away?</p>
<p>The issue is that some objects have multiple geometries:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/st_geometry_type">st_geometry_type</a></span>(near_lnd)</a></code></pre></div>
<pre><code>## [1] MULTIPOLYGON MULTIPOLYGON MULTIPOLYGON MULTIPOLYGON MULTIPOLYGON
## [6] MULTIPOLYGON MULTIPOLYGON
## 18 Levels: GEOMETRY POINT LINESTRING POLYGON ... TRIANGLE</code></pre>
<p>Which have more than 1?</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(near_lnd<span class="op">$</span>name_long,</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">           <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(near_lnd<span class="op">$</span>geom, length))</a></code></pre></div>
<pre><code>##   near_lnd.name_long sapply.near_lnd.geom..length.
## 1             France                             3
## 2            Germany                             1
## 3         Luxembourg                             1
## 4            Belgium                             1
## 5        Netherlands                             1
## 6            Ireland                             1
## 7     United Kingdom                             2</code></pre>
<p>We can resolve this issue by casting them:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">world_poly =<span class="st"> </span>world <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/st_cast">st_cast</a></span>(<span class="dt">to =</span> <span class="st">"POLYGON"</span>)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">near_lnd_new =<span class="st"> </span>world_poly[lnd_buff, ]</a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/st_geometry">st_geometry</a></span>(near_lnd_new))</a></code></pre></div>
<p><img src="tidyverse-pitfalls_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div id="pitfall-spatial-subsetting" class="section level2">
<h2 class="hasAnchor">
<a href="#pitfall-spatial-subsetting" class="anchor"></a>Pitfall: spatial subsetting</h2>
<p>The previous code chunk shows how spatial subsetting works in base R, with <code>near_lnd = world_poly[lnd_buff, ]</code>.</p>
<p>You can also do tidy spatial subsetting:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">near_lnd_tidy =<span class="st"> </span>world <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/geos_binary_pred">st_intersects</a></span>(., lnd_buff, <span class="dt">sparse =</span> <span class="ot">FALSE</span>))</a></code></pre></div>
<p>But there are pitfalls:</p>
<ul>
<li>It’s verbose (you need <code>sparse = FALSE</code> in the spatial predicate function)</li>
<li>See the next pitfall: it boshes the row names!</li>
</ul>
</div>
<div id="pitfall-row-names" class="section level2">
<h2 class="hasAnchor">
<a href="#pitfall-row-names" class="anchor"></a>Pitfall: row names</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/row.names">row.names</a></span>(near_lnd_tidy)</a></code></pre></div>
<pre><code>## [1] "1" "2" "3" "4" "5" "6" "7"</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/row.names">row.names</a></span>(near_lnd)</a></code></pre></div>
<pre><code>## [1] "44"  "122" "129" "130" "131" "134" "144"</code></pre>
<ul>
<li>Consequences for joining - rownames can be useful!</li>
</ul>
<p>Also affects non-spatial data - <a href="https://github.com/tidyverse/dplyr/issues/366">tidyverse/dplyr#366</a></p>
</div>
<div id="pitfall-attribute-alteration" class="section level2">
<h2 class="hasAnchor">
<a href="#pitfall-attribute-alteration" class="anchor"></a>Pitfall: attribute alteration</h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">world <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(name_long <span class="op">==</span><span class="st"> "United Kingdom"</span>)</a></code></pre></div>
<pre><code>## Simple feature collection with 1 feature and 10 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -7.572168 ymin: 49.96 xmax: 1.681531 ymax: 58.635
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
##   iso_a2      name_long continent region_un       subregion    type
## 1     GB United Kingdom    Europe    Europe Northern Europe Country
##   area_km2      pop  lifeExp gdpPercap                           geom
## 1 249986.4 64613160 81.30488  38251.79 MULTIPOLYGON (((-6.197885 5...</code></pre>
<p>Base R equivalent:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">world[world<span class="op">$</span>name_long <span class="op">==</span><span class="st"> "United Kingdom"</span>, ]</a></code></pre></div>
<p>Question:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/identical">identical</a></span>(</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">  world <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(name_long <span class="op">==</span><span class="st"> "United Kingdom"</span>),</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">  world[world<span class="op">$</span>name_long <span class="op">==</span><span class="st"> "United Kingdom"</span>, ]</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">) <span class="co"># ?</span></a></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>Row names usually don’t matter but they can bite.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">u1 =<span class="st"> </span>world <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(name_long <span class="op">==</span><span class="st"> "United Kingdom"</span>)</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">u2 =<span class="st"> </span>world[world<span class="op">$</span>name_long <span class="op">==</span><span class="st"> "United Kingdom"</span>, ]</a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/row.names">row.names</a></span>(u2) =<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb32-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/identical">identical</a></span>(u1, u2)</a></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<ul>
<li>Advanced challenge: how to make u1 and u2 identical?</li>
</ul>
</div>
<div id="pitfall-binding-rows" class="section level2">
<h2 class="hasAnchor">
<a href="#pitfall-binding-rows" class="anchor"></a>Pitfall: binding rows</h2>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(near_lnd, near_lnd) <span class="co"># works</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="kw">bind_rows</span>(near_lnd, near_lnd)</a></code></pre></div>
<pre><code>Error in .subset2(x, i, exact = exact) : 
  attempt to select less than one element in get1index</code></pre>
<p>But this does:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">near_lnd_data =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/st_geometry">st_set_geometry</a></span>(near_lnd, <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">d =<span class="st"> </span><span class="kw">bind_rows</span>(near_lnd_data, near_lnd_data)</a>
<a class="sourceLine" id="cb36-3" data-line-number="3">d_sf =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/sf/topics/sf">st_sf</a></span>(d, <span class="dt">geometry =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(near_lnd<span class="op">$</span>geom, near_lnd<span class="op">$</span>geom))</a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(d_sf)</a></code></pre></div>
<p><img src="tidyverse-pitfalls_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
<div id="raster-data-in-the-tidyverse" class="section level2">
<h2 class="hasAnchor">
<a href="#raster-data-in-the-tidyverse" class="anchor"></a>Raster data in the tidyverse</h2>
<p>Raster data is not yet closely connected to the <strong>tidyverse</strong>, however:</p>
<ul>
<li>Some functions from the <strong>raster</strong> package work well in <code>pipes</code>
</li>
<li>You can convert vector data to the <code>Spatial*</code> form using <code><a href="https://www.rdocumentation.org/packages/sf/topics/coerce-methods">as(my_vector, "Spatial")</a></code>before working on raster-vector interactions</li>
<li>There are some initial efforts to bring raster data closer to the <strong>tidyverse</strong>, such as <a href="https://github.com/hypertidy/tabularaster">tabularaster</a>, <a href="https://github.com/mdsumner/sfraster">sfraster</a>, or <a href="https://github.com/ecohealthalliance/fasterize">fasterize</a>, and <a href="https://github.com/r-spatial/stars">stars</a> - package focused on multidimensional, large datasets</li>
</ul>
<!-- ## Practical exercises --><!-- In groups of 2:4: --><!-- -- Work-through section 3.2 in the handout --><!-- -- Answer questions 1:3 --><!-- -- --><!-- A) Beginner/tidyverse consolidation: Tackle the exercises in [Chapter 3](http://geocompr.robinlovelace.net/attr.html) of Geocomputation with R --><!-- -- --><!-- B) Intermediate/advanced: Build on Edzer's [`breweries` analysis](https://edzer.github.io/UseR2017/) and answer the questions using tidyverse functions: --><!-- 1. which was the earliest founded brewery? --><!-- 2. which has the longest name? --><!-- 3. group the breweries by the century they were founded: which has, on average, most beer types? --><!-- 4. Join the breweries to a 5km buffer around the trails: which trail is the best for number/diversity of breweries? --><!-- -- -->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#context">Context</a></li>
      <li><a href="#loading-spatial-packages">Loading spatial packages</a></li>
      <li><a href="#pitfall-name-clashes">Pitfall: name clashes</a></li>
      <li><a href="#pitfall-tidyverse-and-sp-dont-play">Pitfall: tidyverse and sp don’t play</a></li>
      <li><a href="#pitfall-multipolygon-objects">Pitfall: multipolygon objects</a></li>
      <li><a href="#pitfall-spatial-subsetting">Pitfall: spatial subsetting</a></li>
      <li><a href="#pitfall-row-names">Pitfall: row names</a></li>
      <li><a href="#pitfall-attribute-alteration">Pitfall: attribute alteration</a></li>
      <li><a href="#pitfall-binding-rows">Pitfall: binding rows</a></li>
      <li><a href="#raster-data-in-the-tidyverse">Raster data in the tidyverse</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robin Lovelace, Jakub Nowosad, Jannes Muenchow.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
